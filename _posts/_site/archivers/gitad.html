<h3 id="在整个git仓库提交历史中找寻并删除内容">在整个git仓库提交历史中找寻并删除内容</h3>

<p>你有时可能需要查找一行你写的代码，但是就是无法找到。它可能安放在了一些已经被遗忘的分支，或是删除了很久，又或是就在那显而易见的地方。无论哪种方式，你都可以通过一些命令在整个git仓库的历史中搜寻特定的字符串。</p>

<p>首先，我们需要拿到所有的提交，然后，使用git grep来搜寻特定的字符串。如下：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">git</span> <span class="nx">rev</span><span class="o">-</span><span class="nx">list</span> <span class="o">--</span><span class="nx">all</span> <span class="o">|</span> <span class="nx">xargs</span> <span class="nx">git</span> <span class="nx">grep</span> <span class="o">-</span><span class="nx">F</span> <span class="s1">'搜寻的字符串'</span>
</code></pre></div></div>

<p>你可能有一个粗心的朋友不小心在仓库里提交了诸如，用户名、密码、外婆的大蒜食谱等敏感信息。首先，他们得更改用户名、密码（并向外婆道歉）。然后，你需要搜寻这些得罪人的文件，并将他们从整个仓库的历史里抹去（这听起来好像很容易）。经过这个处理，那些执行git pull的伙计们就会发现所有提交中包含的敏感信息都被清理干净了，而那些没有合并你的远程改动的家伙还是拥有敏感信息（所以，千万别忘记先改用户名和密码）。我们来看看怎么操作。</p>

<p>首先，重写每个分支的历史，移除敏感信息：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">git</span> <span class="nx">filter</span><span class="o">-</span><span class="nx">branch</span> <span class="o">--</span><span class="nx">index</span><span class="o">-</span><span class="nx">filter</span> <span class="s1">'git rm --cached --ignore-unmatch (filename)'</span> <span class="o">--</span><span class="nx">prune</span><span class="o">-</span><span class="nx">empty</span> <span class="o">--</span><span class="nx">tag</span><span class="o">-</span><span class="nx">name</span><span class="o">-</span><span class="nx">filter</span> <span class="nx">cat</span> <span class="o">--</span> <span class="o">--</span><span class="nx">all</span>
</code></pre></div></div>

<p>然后，将记录敏感信息的文件增加到.gitignore文件，并提交（括号部分替换为对应文件名）：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">echo</span> <span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">.</span><span class="nx">gitignore</span>
<span class="nx">git</span> <span class="nx">add</span> <span class="p">.</span><span class="nx">gitignore</span>
<span class="nx">git</span> <span class="nx">commit</span> <span class="o">-</span><span class="nx">m</span> <span class="s2">"Add sensitive (filename) file to gitignore"</span>
</code></pre></div></div>

<p>接着，由于我们改写了历史，我们需要“强制”的将改动推到远程：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">git</span> <span class="nx">push</span> <span class="nx">origin</span> <span class="nx">master</span> <span class="o">--</span><span class="nx">force</span>
</code></pre></div></div>

<p>最后，这个文件还在你的本地仓库里，还需要将它完全抹除：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">du</span> <span class="o">-</span><span class="nx">hs</span> <span class="p">.</span><span class="nx">git</span><span class="o">/</span><span class="nx">objects</span>
<span class="nx">rm</span> <span class="o">-</span><span class="nx">rf</span> <span class="p">.</span><span class="nx">git</span><span class="o">/</span><span class="nx">refs</span><span class="o">/</span><span class="nx">original</span><span class="o">/</span>
<span class="nx">git</span> <span class="nx">reflog</span> <span class="nx">expire</span> <span class="o">--</span><span class="nx">expire</span><span class="o">=</span><span class="nx">now</span> <span class="o">--</span><span class="nx">all</span>
<span class="nx">git</span> <span class="nx">gc</span> <span class="o">--</span><span class="nx">prune</span><span class="o">=</span><span class="nx">now</span>
<span class="nx">git</span> <span class="nx">gc</span> <span class="o">--</span><span class="nx">aggressive</span> <span class="o">--</span><span class="nx">prune</span><span class="o">=</span><span class="nx">now</span>
<span class="nx">du</span> <span class="o">-</span><span class="nx">hs</span> <span class="p">.</span><span class="nx">git</span><span class="o">/</span><span class="nx">objects</span>
</code></pre></div></div>

<p>你这粗心的朋友从敏感文件的危机中解脱，而你用你高超的git知识成功逆袭，成为了他的英雄！</p>

<p>译者注：一天，妹子叫我去她家帮她把她的三围信息从git仓库的历史里完全删除，我研究了很久不得要领。妹子说，不如我们做点其它的事吧。我觉得我的git知识被她鄙视了，坚定的说，我一定要把它删掉！然后，就没有然后了… …</p>

<h2 id="清理git仓库">清理git仓库</h2>

<p>首先进行 Git 垃圾回收：</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">git</span> <span class="nx">gc</span> <span class="o">--</span><span class="nx">auto</span>
</code></pre></div></div>

<p>其次查看 Git 仓库占用空间：</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">du</span> <span class="o">-</span><span class="nx">hs</span> <span class="p">.</span><span class="nx">git</span><span class="o">/</span><span class="nx">objects</span>
</code></pre></div></div>

<p>清理历史中的文件：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">git</span> <span class="nx">filter</span><span class="o">-</span><span class="nx">branch</span> <span class="o">--</span><span class="nx">force</span> <span class="o">--</span><span class="nx">index</span><span class="o">-</span><span class="nx">filter</span> <span class="s1">'git rm --cached --ignore-unmatch ****/nohup.out'</span> <span class="o">--</span><span class="nx">prune</span><span class="o">-</span><span class="nx">empty</span> <span class="o">--</span><span class="nx">tag</span><span class="o">-</span><span class="nx">name</span><span class="o">-</span><span class="nx">filter</span> <span class="nx">cat</span> <span class="o">--</span> <span class="o">--</span><span class="nx">all</span>
<span class="nx">git</span> <span class="nx">filter</span><span class="o">-</span><span class="nx">branch</span> <span class="o">--</span><span class="nx">index</span><span class="o">-</span><span class="nx">filter</span> <span class="s1">'git rm --cached --ignore-unmatch ****/nohup.out'</span> <span class="nx">HEAD</span>
<span class="nx">git</span> <span class="k">for</span><span class="o">-</span><span class="nx">each</span><span class="o">-</span><span class="nx">ref</span> <span class="o">--</span><span class="nx">format</span><span class="o">=</span><span class="s2">"%(refname)"</span> <span class="nx">refs</span><span class="o">/</span><span class="nx">original</span><span class="o">/</span> <span class="o">|</span> <span class="nx">xargs</span> <span class="o">-</span><span class="nx">n</span> <span class="mi">1</span> <span class="nx">git</span> <span class="nx">update</span><span class="o">-</span><span class="nx">ref</span> <span class="o">-</span><span class="nx">d</span>
</code></pre></div></div>

<p>强制提交覆盖：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">git</span> <span class="nx">reflog</span> <span class="nx">expire</span> <span class="o">--</span><span class="nx">expire</span><span class="o">=</span><span class="nx">now</span> <span class="o">--</span><span class="nx">all</span> <span class="nx">git</span> <span class="nx">gc</span> <span class="o">--</span><span class="nx">prune</span><span class="o">=</span><span class="nx">now</span> <span class="nx">git</span> <span class="nx">push</span> <span class="o">--</span><span class="nx">all</span> <span class="o">--</span><span class="nx">force</span> <span class="nx">git</span> <span class="nx">push</span> <span class="o">--</span><span class="nx">all</span> <span class="o">--</span><span class="nx">tags</span> <span class="o">--</span><span class="nx">force</span>
</code></pre></div></div>

<p>但是这个方案有 2 个问题：1. 处理速度慢，尝试清理 2 G 大小的代码库，用了 1 晚上还没跑完。2. 只能按文件名清理，如果不同的路径有同样的文件名就无法处理了，可能误删文件或者忽略某些文件。当然有个非常好的解决方案完美解决了这个问题。</p>
